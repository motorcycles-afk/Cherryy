<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - Cherry</title>
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>Cherry</h1>
        </div>
        <ul class="nav-links">
            <li>
                <a href="#" class="active">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <i class="fas fa-key"></i>
                    <span>My Keys</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </li>
            <li>
                <a href="#" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="dashboard-header">
            <h2 class="dashboard-title">Welcome, <span id="username">User</span></h2>
            <div class="user-status">
                <span class="status-badge">Active</span>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="card-grid">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Active Keys</h3>
                    <i class="fas fa-key"></i>
                </div>
                <div class="card-value" id="activeKeys">0</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Days Active</h3>
                    <i class="fas fa-calendar"></i>
                </div>
                <div class="card-value" id="daysActive">0</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Last Login</h3>
                    <i class="fas fa-clock"></i>
                </div>
                <div class="card-value" id="lastLogin">Never</div>
            </div>
        </div>

        <!-- Key Management -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">My Keys</h3>
                <button class="btn btn-primary" id="generateKeyBtn">
                    <i class="fas fa-plus"></i> Generate New Key
                </button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>Created</th>
                            <th>Expires</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="keysTable">
                        <!-- Keys will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Recent Activity</h3>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Action</th>
                            <th>Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="activityTable">
                        <!-- Activity will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Check authentication
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user'));

        if (!token || !user) {
            window.location.href = 'login.html';
        }

        // Set username
        document.getElementById('username').textContent = user.username;

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        });

        // Fetch user data
        async function fetchUserData() {
            try {
                const response = await fetch('/api/user/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch user data');
                }

                const data = await response.json();
                
                // Update stats
                document.getElementById('activeKeys').textContent = data.activeKeys || 0;
                document.getElementById('daysActive').textContent = data.daysActive || 0;
                document.getElementById('lastLogin').textContent = data.lastLogin ? new Date(data.lastLogin).toLocaleString() : 'Never';

                // Update keys table
                const keysTable = document.getElementById('keysTable');
                keysTable.innerHTML = data.keys.map(key => `
                    <tr>
                        <td>${key.value}</td>
                        <td>${new Date(key.createdAt).toLocaleString()}</td>
                        <td>${new Date(key.expiresAt).toLocaleString()}</td>
                        <td>
                            <span class="status-badge ${key.active ? 'active' : 'expired'}">
                                ${key.active ? 'Active' : 'Expired'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm ${key.active ? 'btn-danger' : 'btn-primary'}"
                                    onclick="toggleKey('${key._id}')">
                                ${key.active ? 'Deactivate' : 'Activate'}
                            </button>
                        </td>
                    </tr>
                `).join('');

                // Update activity table
                const activityTable = document.getElementById('activityTable');
                activityTable.innerHTML = data.recentActivity.map(activity => `
                    <tr>
                        <td>${activity.action}</td>
                        <td>${new Date(activity.date).toLocaleString()}</td>
                        <td>
                            <span class="status-badge ${activity.status.toLowerCase()}">
                                ${activity.status}
                            </span>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error fetching user data:', error);
            }
        }

        // Generate new key
        document.getElementById('generateKeyBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/user/generate-key', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to generate key');
                }

                // Refresh data
                fetchUserData();

            } catch (error) {
                console.error('Error generating key:', error);
            }
        });

        // Toggle key status
        async function toggleKey(keyId) {
            try {
                const response = await fetch(`/api/user/toggle-key/${keyId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to toggle key');
                }

                // Refresh data
                fetchUserData();

            } catch (error) {
                console.error('Error toggling key:', error);
            }
        }

        // Initial fetch
        fetchUserData();

        // Refresh data every 30 seconds
        setInterval(fetchUserData, 30000);
    </script>
</body>
</html>
